#!/bin/ksh
#
# Copyright (c) 2014 T. R. Burghart.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Author:     Ted Burghart
# Version:    1
# Revision:   2   2014-11-24T17:53:54Z

typeset  -r OWNER='Basho Technologies, Inc.'
typeset  -r AUTHOR='Ted Burghart'

typeset  -r infile="$(cd "$(dirname "$0")" && pwd)/${0##*/}"

typeset  -r SedBase="$(mktemp -t ne)"
typeset  -r AwkSrcP="$(mktemp -t ne)"
typeset  -r AwkHdrP="$(mktemp -t ne)"

trap "rm $SedBase $AwkSrcP $AwkHdrP" EXIT

eval $(date -u '+typeset -r DATE="%Y-%m-%d"; typeset -r TIME="%H:%M:%S";')

cat >$AwkSrcP <<EOF
BEGIN { PL = 0 }
/^===== [A-Z]+ END =====/ { PL = 0 }
PL > 0
/^===== COPYRIGHT BEGIN =====/ { PL = 1 }
/^===== MODULE BEGIN =====/ { PL = 1 }
EOF
cat >$AwkHdrP <<EOF
BEGIN { PL = 0 }
/^===== [A-Z]+ END =====/ { PL = 0 }
PL > 0
/^===== COPYRIGHT BEGIN =====/ { PL = 1 }
/^===== HEADER BEGIN =====/ { PL = 1 }
EOF
cat >$SedBase <<EOF
s!@@OWNER@@!${OWNER}!g
s!@@AUTHOR@@!${AUTHOR}!g
s!@@YEAR@@!${DATE%%-*}!g
s!@@DATE@@!${DATE}!g
s!@@TIME@@!${TIME}!g
s!@@DATETIME@@!${DATE}T${TIME}Z!g
EOF

typeset  -r FiltSrc="awk -f $AwkSrcP $infile"
typeset  -r FiltHdr="awk -f $AwkHdrP $infile"
typeset  -r FiltSed="sed -E -f $SedBase"

for outfile in "$@"
do
    if [[ -f "$outfile" ]]
    then
        echo "$outfile" already exists! >&2
        continue
    fi
    filename="${outfile##*/}"
    basename="${filename%.*}"
    filetype="${filename#${basename}}"

    if [[ "$filetype" == '.hrl' ]]
    then
        # probably more elaborate than needed, but I want 5
        # random digits to append to the include guard and
        # the shell's RANDOM is limited to 15 bits
        typeset -i  randi=0
        while true
        do
            randi="0x$(openssl rand -hex 3)"
            [[ $randi -lt 100000 ]] || break
        done
        typeset -R5 rands="$randi"
        typeset -u  guard="${filename//./_}_included_$rands"
        $FiltHdr | $FiltSed -e "s/@@INCL_GUARD@@/${guard}/g" >"$outfile"
    else
        $FiltSrc | $FiltSed -e "s/@@MODULE@@/${basename}/g" >"$outfile"
    fi
done

exit

===== COPYRIGHT BEGIN =====
%% -------------------------------------------------------------------
%%
%% Copyright (c) @@YEAR@@ @@OWNER@@
%%
%% This file is provided to you under the Apache License,
%% Version 2.0 (the "License"); you may not use this file
%% except in compliance with the License.  You may obtain
%% a copy of the License at
%%
%%   http://www.apache.org/licenses/LICENSE-2.0
%%
%% Unless required by applicable law or agreed to in writing,
%% software distributed under the License is distributed on an
%% "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
%% KIND, either express or implied.  See the License for the
%% specific language governing permissions and limitations
%% under the License.
%%
%% -------------------------------------------------------------------
===== COPYRIGHT END =====

===== MODULE BEGIN =====
-module(@@MODULE@@).
-author("@@AUTHOR@@").
-version("0.0.0").
-revision(["0", "@@DATETIME@@"]).

-include("local_defs.hrl").

-include("@@MODULE@@_internal.hrl").
-include("@@MODULE@@.hrl").

%%======================================================================
%%  Public API
%%======================================================================
-export([
    
]).

-export_type([
    
]).

%%======================================================================
%%  Types
%%======================================================================


%%======================================================================
%%  API functions
%%======================================================================


%%======================================================================
%%  Internal functions
%%======================================================================


%%======================================================================
%%  EUnit Tests
%%======================================================================
-ifdef(TEST).


-endif. % TEST

===== MODULE END =====

===== HEADER BEGIN =====

%%  Author:     @@AUTHOR@@
%%  Version:    0.0.0
%%  Revision:   0   @@DATETIME@@
%%
%%  The trailing number is random, it exists only to avoid guard conflicts.
-ifndef(@@INCL_GUARD@@).
-define(@@INCL_GUARD@@, true).


-endif. % @@INCL_GUARD@@
===== HEADER END =====
